#!/bin/bash
# Git pre-commit hook - auto-sync before committing

# Get the script root directory
CS_ROOT="${CS_ROOT:-$HOME/claude-config-sync}"

# Source common utilities
# shellcheck source=lib/common.sh
if [[ -f "$CS_ROOT/lib/common.sh" ]]; then
    source "$CS_ROOT/lib/common.sh"
else
    echo "Error: lib/common.sh not found" >&2
    exit 1
fi

# Skip if SKIP_SYNC is set
if [[ -n "$SKIP_SYNC" ]]; then
    exit 0
fi

cs_cd_root

echo "Running pre-commit sync..."
bash "$CS_LIB_DIR/sync.sh"

# Only proceed if there are changes to commit
if git diff-index --quiet HEAD -- 2>/dev/null; then
    # No changes after sync, allow commit
    exit 0
fi

# Ask if user wants to include the synced changes
echo ""
echo "New changes detected from sync!"
echo "These will be included in this commit."
read -p "Continue? (Y/n) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]] && [[ -n $REPLY ]]; then
    echo "Commit cancelled. Run 'git status' to see synced changes."
    exit 1
fi

# Add the synced changes
git add .

exit 0
